CLAUDE'S ANSWERS TO CHATGPT - ORACLEBOX ARCHITECTURE
====================================================

GENERAL QUESTIONS
=================

1. How are you organizing your code files?
   
   ANSWER: Using PlatformIO structure (not Arduino IDE .ino)
   - src/main.cpp - main firmware logic
   - include/config.h - WiFi credentials, device ID, thresholds
   - include/melodies.h - note definitions and melody arrays (Music Box only)
   - No classes, using functional C++ with global state variables

2. Are you using Arduino core for ESP32 or ESP-IDF?
   
   ANSWER: Arduino framework via PlatformIO
   - framework = arduino in platformio.ini
   - Using Arduino WiFi, Wire, tone() functions

3. What pin numbers did you assign?
   
   ANSWER:
   
   MUSIC BOX:
   - PIR: GPIO 35 (AM312 motion sensor)
   - Passive buzzer: GPIO 27 (PWM for tones)
   - LED Status: GPIO 2 (built-in LED)
   - LED Trigger: GPIO 26 (external LED)

   REM-POD:
   - AT42QT1011 OUT: GPIO 34 (capacitive touch sensor)
   - Active buzzer: GPIO 25
   - LED Status: GPIO 2 (built-in LED)
   - LED Trigger: GPIO 26 (external LED)
   - BMP280 SDA: GPIO 21 (I2C)
   - BMP280 SCL: GPIO 22 (I2C)
   - Telescopic antenna: Connected directly to AT42QT1011 sense pad (no ESP32 pin)

4. Are you using tone() or a custom PWM/timer for sound?
   
   ANSWER: Using Arduino tone() function for passive buzzer (Music Box)
   - Using digitalWrite() HIGH/LOW for active buzzer (REM-Pod)
   - No custom PWM timers

5. Do you debounce PIR or rely on raw detection?
   
   ANSWER: Using cooldown timer instead of debounce
   - PIR_HOLDTIME = 5000ms (configurable in config.h)
   - Only trigger if (millis() - lastTrigger > PIR_HOLDTIME)
   - No digital debounce library needed


MELODY / AUDIO QUESTIONS
========================

6. Are melodies stored in separate .h files, global struct/array, or hard-coded?
   
   ANSWER: Separate include/melodies.h file
   - Each melody is 3 const arrays:
     * melody_name[] - note frequencies
     * durations_name[] - note durations in ms
     * melody_name_length - integer count
   - Example: melody_twinkle_star[], durations_twinkle_star[], melody_twinkle_length

7. Do you plan to add more melodies later?
   
   ANSWER: YES - designed for easy expansion
   - Just add new arrays to melodies.h
   - Add else if clause in playMelody() function
   - Update config.h comment with new option
   - Update Android app spinner

8. Do you want the ESP32 to choose melodies?
   
   ANSWER: FIXED - set in config.h at compile time
   - #define MELODY "twinkle_star" (or "lullaby", "carousel")
   - Can be changed via Android app command: MUSICBOX MELODY <name>
   - Future: Could add random selection mode

9. Do you want the buzzer to stop early if PIR turns off?
   
   ANSWER: NO - melody plays to completion once triggered
   - PIR is checked AFTER melody finishes
   - This prevents interrupted/stuttering playback
   - Cooldown prevents re-trigger during playback


REM-POD QUESTIONS
=================

10. How are you reading the AT42QT1011 sensor output?
    
    ANSWER: digitalRead(AT42QT1011_PIN) in loop
    - No interrupt, polling at 50ms intervals
    - Has trigger count accumulator for stability:
      * triggerCount++ when HIGH
      * triggerCount-- when LOW
      * Only fires event when triggerCount >= TRIGGER_THRESHOLD
    - Cooldown: 2000ms between events

11. Do you have sensitivity levels implemented?
    
    ANSWER: YES - strength calculated 0-10 scale
    - Based on trigger persistence (how long sensor stays HIGH)
    - strength = map(triggerCount, TRIGGER_THRESHOLD, TRIGGER_THRESHOLD*3, 3, 10)
    - Sent in JSON: "strength": 7
    - Used for buzzer duration scaling and LED blink count

12. Do you want color-coded LEDs for proximity?
    
    ANSWER: NOT IMPLEMENTED YET
    - Currently just single LED that blinks faster for stronger signals
    - Could add RGB LED in future with color mapping:
      * Green (1-3): Weak
      * Yellow (4-6): Medium
      * Orange (7-8): Strong
      * Red (9-10): Very Strong

13. How do you want temperature deviation alerts handled?
    
    ANSWER: Threshold: ±2.0°F rapid change
    - Check every 5 seconds (TEMP_CHECK_INTERVAL)
    - Alert triggers:
      * 2 quick LED blinks
      * JSON event sent to hub: "event": "temp_deviation"
      * Includes current temp and pressure in message
    - No buzzer sound for temp alerts (only EM triggers get buzzer)

14. Do you want both REM-Pod and ATDD running at the same time?
    
    ANSWER: Not sure what ATDD is?
    - REM-Pod checks EM field AND temperature simultaneously in loop
    - Both can trigger independently
    - EM trigger = buzzer + LED + strength rating
    - Temp deviation = LED only + alert message


MUSIC BOX QUESTIONS
===================

15. How long is your cooldown after a PIR trigger?
    
    ANSWER: 5000ms (5 seconds) - PIR_HOLDTIME in config.h
    - Configurable per device
    - Prevents re-trigger spam during melody playback

16. Do you want auto-shutoff after X minutes of inactivity?
    
    ANSWER: NOT IMPLEMENTED
    - Currently runs 24/7 in passive monitoring mode
    - Could add sleep mode for battery conservation
    - Suggestion: Sleep after 30 min idle, wake on PIR interrupt

17. Do you want a "spirit mode" where the tune plays slower or detuned?
    
    ANSWER: NOT IMPLEMENTED - great idea!
    - Could add:
      * Slower tempo: multiply all durations by 1.5x
      * Detuned: subtract 10-20Hz from each note
      * Random pauses between notes
      * Could trigger randomly (10% chance) or based on time of night

18. Do you want fading LEDs in sync with the melody?
    
    ANSWER: NOT IMPLEMENTED
    - Currently LED just stays solid during playback
    - Could add PWM fade on LED_TRIGGER pin synced to note timing
    - Would need to use analogWrite() instead of digitalWrite()


HUB + SATELLITES ARCHITECTURE QUESTIONS
========================================

19. Are you planning for ESP32 → Pi communication over HTTP/WebSocket/UDP/ESP-NOW/custom?
    
    ANSWER: WiFiClient TCP socket connection
    - Hub IP: 192.168.4.1 (Pi creates WiFi AP)
    - Hub Port: 8888
    - Protocol: Send JSON string, Pi responds (optional)
    - One-line JSON per event, newline terminated
    - NOT using HTTP/WebSocket/ESP-NOW

20. If no internet, should the Pi create a WiFi AP?
    
    ANSWER: YES - THIS IS THE DESIGN
    - Pi runs hostapd creating isolated WiFi network
    - SSID: "OracleBox-Network"
    - No internet routing (closed network for investigations)
    - DHCP range: 192.168.4.2 - 192.168.4.20
    - ESP32 satellites connect as clients

21. What data format do you want the satellites to send?
    
    ANSWER: JSON strings
    - One JSON object per line
    
    Example Music Box:
    {
      "device": "musicbox",
      "id": "musicbox_01",
      "location": "bedroom",
      "event": "motion_detected",
      "melody": "twinkle_star",
      "duration": 5000,
      "battery": 72,
      "timestamp": 1701234567
    }
    
    Example REM-Pod:
    {
      "device": "rempod",
      "id": "rempod_01",
      "location": "hallway",
      "event": "em_trigger",
      "strength": 7,
      "temperature": 68.5,
      "pressure": 1013.25,
      "battery": 85,
      "timestamp": 1701234567
    }

22. Do you want unique device IDs for each node?
    
    ANSWER: YES - IMPLEMENTED
    - Set in config.h: #define DEVICE_ID "rempod_01"
    - Set in config.h: #define LOCATION "hallway"
    - Allows multiple devices of same type
    - Android app will display device ID + location
    - Suggestion: Use format <type>_<number> (rempod_01, rempod_02, musicbox_01)

23. Do you want the Pi to speak alerts aloud?
    
    ANSWER: YES - PLANNED
    - Pi already has espeak-ng + sox for voice synthesis
    - Voice announcements with vintage radio effects
    - Examples:
      * "REM-Pod trigger in hallway — strength 7"
      * "Music Box activated in bedroom"
      * "Temperature deviation detected — 3 degrees"
    - Pi needs to parse JSON events and call voice synthesis

24. Do you want event timestamps synced between Pi and ESP32?
    
    ANSWER: Currently using millis() / 1000 (seconds since boot)
    - NOT synced to real time
    - SHOULD ADD: ESP32 requests Unix timestamp from Pi on connection
    - Store offset, calculate real timestamps
    - Or use NTP if Pi has internet (but we won't have internet at sites)
    - Recommendation: Pi sends timestamp in connection handshake

25. Do you want the Pi app to display a live dashboard?
    
    ANSWER: YES - THIS IS THE GOAL
    - Android app will show:
      * REM-Pod triggers (location, strength, time)
      * Music Box triggers (location, melody, time)
      * Temperature changes (location, delta, time)
      * Battery status for all satellites
      * Connection status (online/offline)
    - Unified event log showing all activity
    - Real-time updates when events received


ADVANCED / FUTURE FEATURES
===========================

26. Should satellites report battery level to the Pi?
    
    ANSWER: YES - IMPLEMENTED
    - "battery": 72 in JSON (percentage 0-100)
    - Currently using simulated drain (for testing)
    - Real implementation needs:
      * Voltage divider on GPIO34 (ADC pin)
      * Read 18650 voltage (3.2V-4.2V)
      * Map to percentage
      * Check every 60 seconds
    - Low battery warnings sent when < 20%

27. Do you want OTA updates for ESP32 devices from the Pi?
    
    ANSWER: NOT IMPLEMENTED
    - Would be very useful for field updates
    - Recommendation:
      * Pi hosts HTTP server with firmware.bin
      * ESP32 checks for updates on boot
      * Uses ArduinoOTA library
      * Could push updates from Android app → Pi → ESP32

28. Do you want mesh networking or single-hop only?
    
    ANSWER: SINGLE-HOP ONLY
    - All ESP32 satellites connect directly to Pi AP
    - No mesh/relay between satellites
    - Simpler, more reliable
    - Range: ~50-100ft depending on walls

29. Do you want the satellites to store events locally if WiFi drops?
    
    ANSWER: NOT IMPLEMENTED
    - Currently events are lost if WiFi down
    - Recommendation:
      * Use ESP32 SPIFFS to store events in queue
      * Send when WiFi reconnects
      * Limit to last 100 events to avoid memory issues
    - Would need significant code additions

30. Do you want an "Investigation Log" auto-generated?
    
    ANSWER: YES - PLANNED
    - Pi should log all events to file
    - Format: CSV or JSON lines
    - Include: timestamp, device, location, event type, data
    - Android app can download/view logs
    - Could generate summary report:
      * Total triggers by location
      * Peak activity times
      * Temperature anomalies
      * Event timeline visualization

31. Do you want encryption on satellite → Pi messages?
    
    ANSWER: NOT IMPLEMENTED
    - Currently plaintext JSON over WiFi
    - Recommendation: Add simple AES encryption if needed
    - Low priority since network is isolated (no internet)
    - More important: Authenticate devices (prevent rogue ESP32s)
    - Could use pre-shared key in config.h


ADDITIONAL ARCHITECTURE NOTES
==============================

LIBRARIES USED:
- ArduinoJson v7.0.0 (JSON serialization)
- Adafruit_BMP280 v2.6.8 (temp/pressure sensor)
- Adafruit_Unified_Sensor v1.1.14 (sensor base)
- WiFi (built-in ESP32)
- Wire (built-in I2C)

ESP32 MEMORY:
- No dynamic memory allocation (malloc/new)
- Using fixed-size buffers
- JsonDocument on stack (not heap)
- Very stable, no memory leaks

ERROR HANDLING:
- WiFi reconnect on disconnect (20 attempts, 500ms delay)
- BMP280 init failure = blink pattern, continue anyway
- Hub connection failure = LED blink, log to Serial, retry next event
- All errors logged via Serial for debugging

POWER CONSUMPTION:
- Music Box: 70mA idle, 110mA active, 140mA playing
- REM-Pod: 80mA idle, 120mA active, 180mA triggering
- Both designed for 18650 Li-ion batteries (2500mAh)
- Expected runtime: 8-14 hours
- Could add deep sleep for multi-day investigations

PI SOCKET SERVER (Not Yet Implemented):
- Needs to listen on port 8888
- Accept connections from satellites
- Read JSON lines
- Parse and log events
- Trigger voice announcements
- Forward to Android app via Bluetooth
- Should be async/threaded (multiple satellites connecting)


CODE STYLE / CONVENTIONS
=========================

NAMING:
- Snake_case for constants: PIR_HOLDTIME, TRIGGER_THRESHOLD
- camelCase for variables: lastTrigger, batteryPercent
- camelCase for functions: connectWiFi(), sendEventToHub()
- UPPER_CASE for #defines: NOTE_C5, WIFI_SSID

SERIAL OUTPUT FORMAT:
- Status: [OK] Message
- Errors: [ERROR] Message
- Warnings: [WARN] Message
- Actions: [*] Message
- Events: [!] Message
- Headers: >>> Message

JSON KEYS:
- "device" - device type (musicbox/rempod)
- "id" - unique device ID
- "location" - human-readable location
- "event" - event type (motion_detected, em_trigger, temp_deviation, low_battery)
- "strength" - REM-Pod strength 0-10 (REM-Pod only)
- "temperature" - degrees Fahrenheit (REM-Pod only)
- "pressure" - hPa (REM-Pod only)
- "melody" - melody name (Music Box only)
- "duration" - melody duration in ms (Music Box only)
- "battery" - percentage 0-100
- "timestamp" - seconds (currently millis/1000, should be Unix time)

CONFIG PATTERN:
- WiFi creds in config.h (same for all devices)
- Device-specific settings in config.h
- Compile-time configuration (no runtime config yet)
- Could add EEPROM storage for runtime changes


WHAT STILL NEEDS TO BE BUILT
=============================

ON PI (Python):
1. WiFi AP setup (hostapd config)
2. Socket server on port 8888
3. JSON parser for satellite events
4. Event logging to file
5. Voice announcement synthesis for events
6. Forward events to Android app via Bluetooth
7. Time sync service for satellites

ON ANDROID APP:
1. REM-Pod activity - live trigger display
2. Music Box activity - motion event timeline
3. Unified event log view
4. Battery status indicators
5. Device connection status
6. Commands: REMPOD TONE, MUSICBOX MELODY

ON ESP32:
1. Real battery monitoring (voltage divider + ADC)
2. Time sync request on connection
3. Optional: Local event storage (SPIFFS)
4. Optional: OTA update support
5. Optional: Spirit mode (detuned melodies)
6. Optional: RGB LED color coding


FINAL NOTES FOR CHATGPT
========================

- Match the JSON schema exactly (keys, structure)
- Use same serial output format for consistency
- Keep pin assignments in config.h for easy changes
- Follow PlatformIO structure (src/, include/, platformio.ini)
- Use ArduinoJson library for all JSON work
- Test on actual hardware - simulators don't work well for tone()
- Comment your code - Dylan will be modifying this
- Keep it simple - paranormal investigations happen at night in dark places
- Battery life is critical - test current draw

If you need more details on any section, ask Dylan to have me elaborate!

— Claude
